import flet as ft
from app.dxcc_list import DXCC_COUNTRIES
from app.ui_components import build_login_controls
from app.data_manager import get_user_file, save_to_excel, load_from_excel
from app.auth import authenticate, register_user


def main(page: ft.Page):
    page.title = "DXCC Need List Tracker"
    page.padding = 20
    page.scroll = "auto"

    current_user = {"callsign": None}

    table = ft.DataTable(
        columns=[
            ft.DataColumn(ft.Text("Country")),
            ft.DataColumn(ft.Text("Callsign")),
            ft.DataColumn(ft.Text("QSO Date")),
            ft.DataColumn(ft.Text("QSL Status")),
            ft.DataColumn(ft.Text("Actions")),
        ],
        rows=[],
    )

    edit_dialog = ft.AlertDialog(modal=True)

    def show_message(msg: str):
        page.snack_bar = ft.SnackBar(ft.Text(msg), open=True)
        page.update()

    def clear_page():
        page.controls.clear()

    def create_row(country, call, date, status):
        return ft.DataRow(
            cells=[
                ft.DataCell(ft.Text(country)),
                ft.DataCell(ft.Text(call)),
                ft.DataCell(ft.Text(date)),
                ft.DataCell(ft.Text(status)),
                ft.DataCell(
                    ft.Row(
                        [
                            ft.IconButton(
                                icon=ft.icons.EDIT,
                                tooltip="Edit",
                                on_click=lambda e: edit_entry(country, call, date, status),
                            ),
                            ft.IconButton(
                                icon=ft.icons.DELETE,
                                tooltip="Delete",
                                on_click=lambda e: delete_entry(country, call, date, status),
                            ),
                        ],
                        spacing=5,
                    )
                ),
            ]
        )

    def export_rows():
        rows = []
        for r in table.rows:
            cells = r.cells
            rows.append(
                [
                    cells[0].content.value,
                    cells[1].content.value,
                    cells[2].content.value,
                    cells[3].content.value,
                ]
            )
        return rows

    def save_user_table():
        if not current_user["callsign"]:
            return
        user_file = get_user_file(current_user["callsign"])
        save_to_excel(export_rows(), user_file)

    def add_entry(country, call, date, status):
        if not country:
            show_message("Select a country first.")
            return
        table.rows.append(create_row(country, call, date, status))
        page.update()
        save_user_table()

    def delete_entry(country, call, date, status):
        for r in list(table.rows):
            cells = r.cells
            if (
                cells[0].content.value == country
                and cells[1].content.value == call
                and cells[2].content.value == date
                and cells[3].content.value == status
            ):
                table.rows.remove(r)
                break
        page.update()
        save_user_table()

    def edit_entry(country, call, date, status):
        country_dd = ft.Dropdown(
            label="Country",
            width=250,
            options=[ft.dropdown.Option(c) for c in DXCC_COUNTRIES],
            value=country,
        )
        call_tf = ft.TextField(label="Callsign", width=200, value=call)
        date_tf = ft.TextField(label="QSO Date (YYYY-MM-DD)", width=200, value=date)
        status_dd = ft.Dropdown(
            label="QSL Status",
            width=200,
            options=[
                ft.dropdown.Option("Needed"),
                ft.dropdown.Option("Requested"),
                ft.dropdown.Option("Confirmed"),
            ],
            value=status,
        )

        def save_changes(e):
            delete_entry(country, call, date, status)
            table.rows.append(
                create_row(
                    country_dd.value,
                    call_tf.value,
                    date_tf.value,
                    status_dd.value,
                )
            )
            page.close(edit_dialog)
            page.update()
            save_user_table()

        edit_dialog.content = ft.Column(
            [
                ft.Text("Edit Entry", size=20, weight="bold"),
                country_dd,
                call_tf,
                date_tf,
                status_dd,
                ft.Row(
                    [
                        ft.ElevatedButton("Save", on_click=save_changes),
                        ft.OutlinedButton(
                            "Cancel", on_click=lambda e: page.close(edit_dialog)
                        ),
                    ],
                    spacing=10,
                    alignment=ft.MainAxisAlignment.END,
                ),
            ],
            tight=True,
        )
        page.dialog = edit_dialog
        edit_dialog.open = True
        page.update()

    def show_app():
        clear_page()
        page.add(
            ft.Row(
                [
                    ft.Text(
                        f"DXCC Need List Tracker â€” {current_user['callsign']}",
                        size=24,
                        weight="bold",
                    ),
                    ft.Container(expand=True),
                    ft.ElevatedButton("Logout", on_click=lambda e: show_login()),
                ]
            )
        )

        country_dd = ft.Dropdown(
            label="Country",
            width=250,
            options=[ft.dropdown.Option(c) for c in DXCC_COUNTRIES],
        )
        call_tf = ft.TextField(label="Callsign", width=200)
        date_tf = ft.TextField(
            label="QSO Date (YYYY-MM-DD)", width=200
        )
        status_dd = ft.Dropdown(
            label="QSL Status",
            width=200,
            options=[
                ft.dropdown.Option("Needed"),
                ft.dropdown.Option("Requested"),
                ft.dropdown.Option("Confirmed"),
            ],
            value="Needed",
        )

        def on_add_click(e):
            add_entry(
                country_dd.value,
                call_tf.value,
                date_tf.value,
                status_dd.value,
            )
            call_tf.value = ""
            date_tf.value = ""
            status_dd.value = "Needed"
            country_dd.value = None
            page.update()

        add_btn = ft.ElevatedButton("Add Entry", on_click=on_add_click)

        def save_click(e):
            save_user_table()
            show_message("Saved to Excel")

        def load_click(e):
            user_file = get_user_file(current_user["callsign"])
            table.rows.clear()
            for country, call, date, status in load_from_excel(user_file):
                table.rows.append(create_row(country, call, date, status))
            page.update()
            show_message("Loaded from Excel")

        # preload from disk
        user_file = get_user_file(current_user["callsign"])
        table.rows.clear()
        for country, call, date, status in load_from_excel(user_file):
            table.rows.append(create_row(country, call, date, status))

        page.add(
            ft.Container(
                ft.Row(
                    [country_dd, call_tf, date_tf, status_dd, add_btn],
                    wrap=True,
                    spacing=10,
                ),
                padding=10,
            ),
            ft.Row(
                [
                    ft.ElevatedButton("Save to Excel", on_click=save_click),
                    ft.ElevatedButton("Reload from Excel", on_click=load_click),
                ],
                spacing=10,
            ),
            ft.Divider(),
            table,
        )
        page.update()

    def show_login():
        clear_page()

        def handle_login(callsign, password):
            ok, msg = authenticate(callsign, password)
            if not ok:
                show_message(msg)
                return
            current_user["callsign"] = callsign.strip().upper()
            show_app()

        def handle_register(callsign, password):
            ok, msg = register_user(callsign, password)
            show_message(msg)
            if ok:
                handle_login(callsign, password)

        controls, _ = build_login_controls(handle_login, handle_register)
        page.add(
            ft.Container(
                controls,
                padding=20,
                alignment=ft.alignment.center,
            )
        )
        page.update()

    show_login()


if __name__ == "__main__":
    ft.app(target=main)
